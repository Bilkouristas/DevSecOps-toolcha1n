name: CI/CD Pipeline 
run-name: Continuous_Integration


on: 
  push: 
    branches: ['master']

jobs:
  Building_app:  
    name: Building the app/Passive scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up node.js
        uses: actions/setup-node@v3
        with: 
          node-version: '12'

      - name: Set up java environment
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Dependencies 
        run: |
          cd WebGoat
          chmod +x mvnw
          ./mvnw clean install

      - name: Build Docker image locally
        run: |
          cd WebGoat
          chmod +x mvnw
          docker build -f Dockerfile . -t webgoat/webgoat 

      - name: Run the project
        id: running  
        run: |
          cd WebGoat
          chmod +x mvnw
          ./mvnw spring-boot:run &
      
      - name: ZAP Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
        #  token: ${{ secrets.GITHUB_TOKEN }}
          docker_name: 'owasp/zap2docker-stable'
          target: 'http://localhost:8080/WebGoat'
        #  rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
  

  Setting_DAST_Tool:
        name: DAST Scans
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Set up node.js
            uses: actions/setup-node@v3
            with: 
              node-version: '12'

          - name: Set up java environment
            uses: actions/setup-java@v3
            with:
              distribution: 'temurin'
              java-version: '17' 

          - name: Setting up DAST-Tool 
            run: |
              cd DAST_Tool/mern-app
              sudo docker-compose up &

          

    WAST_Tests:
        name: WAST Tests and Ajax Scan
        runs-on: ubuntu-latest
        needs: ['Building_app', 'Setting_DAST_Tool']
        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: WDST Tests

            run: |
              cd DAST_Tool/mern-app/zapscanner
              node advanced_scan.js
              

  # Basic_scan:
  #   name: Basic scan
  #   runs-on: ubuntu-latest
  #   needs: Building_app 
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2
  #       with:
  #         ref: master
  #     - name: ZAP Scan
  #       uses: zaproxy/action-baseline@v0.7.0
  #       with:
  #       #  token: ${{ secrets.GITHUB_TOKEN }}
  #         docker_name: 'owasp/zap2docker-stable'
  #         target: 'http://localhost:8080'
  #       #  rules_file_name: '.zap/rules.tsv'
  #         cmd_options: '-a'
    
